!function(e){"use strict";var t={initialize:function(){e(".erp-hr-leave-policy").on("click","a.submitdelete",this,this.policy.remove),e("body").on("change","#erp-hr-leave-req-from-date, #erp-hr-leave-req-to-date",this,this.leave.requestDates),this.leave.setPolicy(),e("body").on("change","#erp-hr-leave-req-employee-id",this,this.leave.setPolicy),e("body").on("change",".new-leave-request-form .f_year, .erp-hr-leave-request-new .f_year",this,this.leave.setPolicy),e("body").on("change","#erp-hr-leave-req-leave-policy",this,this.leave.setAvailableDays),e(".hrm-dashboard").on("click",".erp-hr-new-leave-request-wrap a#erp-hr-new-leave-req",this.leave.takeLeave),e(".erp-employee-single").on("submit","form#erp-hr-empl-leave-history",this.leave.showHistory),e(".entitlement-list-table").on("click","a.submitdelete",this,this.entitlement.remove),e(".erp-hr-holiday-wrap").on("click","a#erp-hr-new-holiday",this,this.holiday.create),e(".erp-hr-holiday-wrap").on("click",".erp-hr-holiday-edit",this,this.holiday.edit),e(".erp-hr-holiday-wrap").on("click",".erp-hr-holiday-delete",this,this.holiday.remove),e(".erp-hr-holiday-wrap").on("click","a#erp-hr-import-holiday",this,this.holiday.import),e("body").on("change",".erp-hr-holiday-date-range",this,this.holiday.checkRange),e("body").on("dblclick","#erp-hr-holiday-data input",function(){e(this).removeAttr("readonly"),e(this).removeAttr("onfocus")}),e("body").on("click","#erp-hr-import-ical",this,this.importICalInit),e(".erp-hr-holiday-wrap").on("change","#erp-ical-input",this,this.uploadICal),e(".erp-hr-leave-requests").on("click",".erp-hr-leave-approve-btn",this,this.leave.approve),e(".erp-hr-leave-requests").on("click",".erp-hr-leave-reject-btn",this,this.leave.reject),e(".request-list-table").on("click","a.submitdelete",this,this.leave.remove),e("#filter_year").on("change",this,this.customFilterLeaveReport),e('input[name="end"], input[name="start"]').on("change",this,this.checkDateRange),e(".leave-entitlement-form").on("change","#assignment_to",this,this.entitlement.hideEmployee),e(".leave-entitlement-form#assignment_to").change(),this.entitlement.getLeavePolicies(),e(".leave-entitlement-form").on("change",".change_policy",this,this.entitlement.getLeavePolicies),e(".leave-entitlement-form").on("change","#leave_policy",this,this.entitlement.getFilteredEmployee),this.initDateField()},initToggleCheckbox:function(){var t=!1;e("tbody").children().children(".check-column").find(":checkbox").click(function(a){if("undefined"==a.shiftKey)return!0;if(a.shiftKey){if(!t)return!0;checks=e(t).closest("form").find(":checkbox").filter(":visible:enabled"),first=checks.index(t),last=checks.index(this),checked=e(this).prop("checked"),0<first&&0<last&&first!=last&&(sliced=last>first?checks.slice(first,last):checks.slice(last,first),sliced.prop("checked",function(){return!!e(this).closest("tr").is(":visible")&&checked}))}t=this;var i=e(this).closest("tbody").find(":checkbox").filter(":visible:enabled").not(":checked");return e(this).closest("table").children("thead, tfoot").find(":checkbox").prop("checked",function(){return 0===i.length}),!0}),e("thead, tfoot").find(".check-column :checkbox").on("click.wp-toggle-checkboxes",function(t){var a=e(this),i=a.closest("table"),r=a.prop("checked"),n=t.shiftKey||a.data("wp-toggle");i.children("tbody").filter(":visible").children().children(".check-column").find(":checkbox").prop("checked",function(){return!e(this).is(":hidden,:disabled")&&(n?!e(this).prop("checked"):!!r)}),i.children("thead,  tfoot").filter(":visible").children().children(".check-column").find(":checkbox").prop("checked",function(){return!n&&!!r})})},initDateField:function(){e(".erp-leave-date-field").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0}),e(".erp-leave-date-picker-from").datepicker({dateFormat:"yy-mm-dd",changeYear:!0,changeMonth:!0,numberOfMonths:1,onClose:function(t){e(".erp-leave-date-picker-to").datepicker("option","minDate",t)}}),e(".erp-leave-date-picker-to").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,numberOfMonths:1,onClose:function(t){e(".erp-leave-date-picker-from").datepicker("option","maxDate",t)}}),e(".erp-leave-datetime-picker-from").datetimepicker({dateFormat:"yy-mm-dd",timeFormat:"HH:mm:ss",changeYear:!0,changeMonth:!0,numberOfMonths:1,onClose:function(t){e(".erp-leave-datetime-picker-to").datetimepicker({dateFormat:"yy-mm-dd",timeFormat:"HH:mm:ss",timeInput:!0,minDate:t});var a=e(this).parent().parent().data("id"),i=new Date(e(this).val().trim()),r=new Date(e(this).closest("td").next("td").find("input").val().trim()),n=Math.round((r-i)/1e3/3600/24),o=n>1?" days":" day";e("#duration-"+a).html(n+o)}}),e(".erp-leave-datetime-picker-to").datetimepicker({dateFormat:"yy-mm-dd",timeFormat:"HH:mm:ss",timeInput:!0,changeMonth:!0,changeYear:!0,numberOfMonths:1,onClose:function(t){e(".erp-leave-datetime-picker-from").datetimepicker({dateFormat:"yy-mm-dd",timeFormat:"HH:mm:ss",timeInput:!0,maxDate:t});var a=e(this).parent().parent().data("id"),i=new Date(e(this).val().trim()),r=new Date(e(this).closest("td").prev("td").find("input").val().trim()),n=Math.round((i-r)/1e3/3600/24),o=n>1?" days":" day";e("#duration-"+a).html(n+o)}}),e(".erp-color-picker").wpColorPicker()},holiday:{checkRange:function(){e('input[name="range"]').is(":checked")?e('input[name="end_date"]').closest(".row").show():e('input[name="end_date"]').closest(".row").hide()},create:function(a){a.preventDefault(),e.erpPopup({title:wpErpHr.popup.holiday,button:wpErpHr.popup.holiday_create,id:"erp-hr-holiday-create-popup",content:wperp.template("erp-hr-holiday-js-tmp")({data:null}).trim(),extraClass:"smaller",onReady:function(){t.initDateField(),t.holiday.checkRange(),t.initToggleCheckbox()},onSubmit:function(e){a.data.holiday.submit.call(this,e)}})},edit:function(a){a.preventDefault();var i=e(this);e.erpPopup({title:wpErpHr.popup.holiday,button:wpErpHr.popup.holiday_update,id:"erp-hr-holiday-create-popup",content:wperp.template("erp-hr-holiday-js-tmp")({data:null}).trim(),extraClass:"smaller",onReady:function(){t.initDateField(),t.holiday.checkRange();var a=this;e("header",a).after(e('<div class="loader"></div>').show()),wp.ajax.send("erp-hr-get-holiday",{data:{id:i.data("id"),_wpnonce:wpErpHr.nonce},success:function(t){e(".loader",a).remove();var i=t.holiday;e("#erp-hr-holiday-title",a).val(i.title),e("#erp-hr-holiday-start",a).val(i.start),e("#erp-hr-holiday-end",a).val(i.end),e("#erp-hr-holiday-id",a).val(i.id),e("#erp-hr-holiday-description",a).val(i.description),e("#erp-hr-holiday-action",a).val("erp_hr_holiday_create");var r=new Date(i.start),n=new Date(i.end),o=Math.abs(n.getTime()-r.getTime());Math.ceil(o/864e5)>0&&(e("#erp-hr-holiday-range").attr("checked","checked"),e("#erp-hr-holiday-range").trigger("change"))}})},onSubmit:function(e){a.data.holiday.submit.call(this,e)}})},remove:function(t){t.preventDefault();var a=e(this);confirm(wpErpHr.delConfirmHoliday)&&wp.ajax.send("erp-hr-holiday-delete",{data:{_wpnonce:wpErpHr.nonce,id:a.data("id")},success:function(){a.closest("tr").fadeOut("fast",function(){e(this).remove()})},error:function(e){alert(e)}})},submit:function(a){wp.ajax.send({data:this.serializeObject(),success:function(i){a.closeModal(),e(".list-table-wrap").load(window.location.href+" .list-wrap-inner",function(){t.initDateField(),t.initToggleCheckbox(),e("#holiday_msg").html(i)})},error:function(e){a.enableButton(),a.showError(e)}})},import:function(a){a.preventDefault(),e.erpPopup({title:wpErpHr.popup.holiday_import,button:wpErpHr.popup.import,id:"erp-hr-holiday-create-popup",content:wperp.template("erp-hr-holiday-import")({data:null}).trim(),extraClass:"small",onReady:function(){t.initDateField(),t.holiday.checkRange()},onSubmit:function(e){a.data.holiday.submit.call(this,e)}})}},policy:{remove:function(t){t.preventDefault();var a=e(this);confirm(wpErpHr.delConfirmPolicy)&&wp.ajax.send("erp-hr-leave-policy-delete",{data:{_wpnonce:wpErpHr.nonce,id:a.data("id")},success:function(){a.closest("tr").fadeOut("fast",function(){e(this).remove()})},error:function(e){alert(e)}})}},entitlement:{remove:function(t){t.preventDefault();var a=e(this);confirm(wpErpHr.delConfirmEntitlement)&&wp.ajax.send("erp-hr-leave-entitlement-delete",{data:{_wpnonce:wpErpHr.nonce,id:a.data("id"),user_id:a.data("user_id"),policy_id:a.data("policy_id")},success:function(){a.closest("tr").fadeOut("fast",function(){e(this).remove()})},error:function(e){alert(e)}})},hideEmployee:function(t){t.preventDefault(),e(this).is(":checked")?e(".single_employee_field").hide():e(".single_employee_field").show()},getLeavePolicies:function(){e(".leave-entitlement-form .leave_policy").find("option").remove(),e(".leave-entitlement-form .leave_policy").prop("disabled",!0);var t=e(".leave-entitlement-form .department_id").select2("data"),a=e(".leave-entitlement-form .designation_id").select2("data"),i=e(".leave-entitlement-form .location_id").select2("data"),r=e(".leave-entitlement-form .gender").select2("data"),n=e(".leave-entitlement-form .marital").select2("data"),o=e(".leave-entitlement-form .f_year").select2("data"),l=e(".leave-entitlement-form .employee_type").select2("data");void 0!==o&&""!=o[0].id&&wp.ajax.send("erp-hr-leave-get-policies",{data:{_wpnonce:wpErpHr.nonce,employee_type:l[0].id,department_id:t[0].id,designation_id:a[0].id,location_id:i[0].id,gender:r[0].id,marital:n[0].id,f_year:o[0].id},success:function(t){var a=e(".leave-entitlement-form .leave_policy");a.find("option").remove(),e.each(t,function(e,t){var i=new Option(t,e);a.append(i)}),a.trigger("change"),a.prop("disabled",!1)},error:function(e){console.log(e)}})},getFilteredEmployee:function(){var t=e(".leave-entitlement-form #leave_policy").val();e(".leave-entitlement-form .single_employee").prop("disabled",!0),void 0!==t&&0!=t&&""!=t&&wp.ajax.send("erp-hr-leave-get-employees",{data:{_wpnonce:wpErpHr.nonce,policy_id:t},success:function(t){var a=e(".leave-entitlement-form .single_employee");a.find("option").remove(),e.each(t,function(e,t){var i=new Option(t,e);a.append(i)}),a.trigger("change"),a.prop("disabled",!1)},error:function(e){console.log(e)}})}},leave:{takeLeave:function(a){a.preventDefault(),e.erpPopup({title:wpErpHr.popup.new_leave_req,button:wpErpHr.popup.take_leave,id:"erp-hr-new-leave-req-popup",content:wp.template("erp-new-leave-req")().trim(),extraClass:"medium",onReady:function(){t.initDateField()},onSubmit:function(t){e("button[type=submit]",".erp-modal").attr("disabled","disabled");var a=e("#erp-hr-new-leave-req-popup .erp-modal-form")[0],i=new FormData(a);e.ajax({type:"POST",enctype:"multipart/form-data",url:ajaxurl,data:i,processData:!1,contentType:!1,cache:!1,timeout:6e5,success:function(e){t.enableButton(),alert(e.data),t.closeModal()},error:function(e){t.enableButton(),t.showError(e)}})}}),t.leave.setPolicy()},requestDates:function(t){var a=e("#erp-hr-leave-req-from-date").val(),i=e("#erp-hr-leave-req-to-date").val(),r=e(this).closest("form").find('*[type="submit"]'),n=parseInt(e("#erp-hr-leave-req-employee-id").val()),o=e("#erp-hr-leave-req-leave-policy").val(),l=e("#halfday"),p=!1;"undefined"!==l.val()&&l.is(":checked")&&(p=!0,"leave_to"===t.target.name)||""!==a&&""!==i&&wp.ajax.send("erp-hr-leave-request-req-date",{data:{_wpnonce:wpErpHr.nonce,from:a,to:i,employee_id:n,type:o},success:function(t){var a=wp.template("erp-leave-days")(t.print);!0===p&&"0"!=t.leave_count&&(a=""),e("div.erp-hr-leave-req-show-days").html(a),parseInt(t.leave_count)<=0?r.prop("disabled",!0):r.prop("disabled",!1)},error:function(t){e("div.erp-hr-leave-req-show-days").empty(),r.attr("disabled","disable"),void 0!==t&&alert(t)}})},setPolicy:function(){t.leave.resetDateRange();e(this);var a=e("div.erp-hr-leave-reqs-wrap"),i=a.find(".erp-hr-leave-type-wrapper");if(i.html(""),0!=e("#erp-hr-leave-req-employee-id").val()){var r=e(".f_year").val();0!=r&&void 0!==r&&wp.ajax.send("erp-hr-leave-employee-assign-policies",{data:{_wpnonce:wpErpHr.nonce,employee_id:e("#erp-hr-leave-req-employee-id").val(),f_year:r},success:function(e){i.html(e).hide().fadeIn(),a.find('input[type="text"], textarea').removeAttr("disabled")},error:function(e){i.html('<div class="notice error"><p>'+e+"</p></div>").hide().fadeIn()}})}},setAvailableDays:function(){t.leave.resetDateRange();var a=e(this);wp.ajax.send("erp-hr-leave-policies-availablity",{data:{_wpnonce:wpErpHr.nonce,employee_id:e("#erp-hr-leave-req-employee-id").val(),policy_id:a.val()},success:function(t){a.closest("div.row").find("span.description").remove(),e(t).insertAfter(a)},error:function(e){alert(e)}})},resetDateRange:function(){e("#erp-hr-leave-req-from-date").val(""),e("#erp-hr-leave-req-to-date").val(""),e("div.erp-hr-leave-req-show-days").html("")},showHistory:function(t){t.preventDefault();var a=e(this);wp.ajax.send("erp-hr-empl-leave-history",{data:a.serializeObject(),success:function(t){e("table#erp-hr-empl-leave-history-table tbody").html(t)}})},approve:function(t){t.preventDefault();var a={id:e(this).data("id")};e.erpPopup({title:wpErpHr.popup.leave_approve,button:wpErpHr.popup.leave_approve_btn,id:"erp-hr-leave-approve-popup",content:wperp.template("erp-hr-leave-approve-js-tmp")(a).trim(),extraClass:"smaller",onSubmit:function(t){wp.ajax.send({data:this.serialize()+"&_wpnonce="+wpErpHr.nonce,success:function(t){var a="";if(t.errors)e.each(t.errors,function(e,t){a+='<div class="notice notice-error is-dismissible"><p>'+t[0]+"</p></div>"}),""!=a&&e("#leave-approve-form-error").html(a);else if(t.redirect){var i=window.location.origin+window.location.pathname+"?1=1";e.each(t.redirect,function(e,t){i+="&"+e+"="+t}),window.location.replace(i)}else{i=window.location.origin+window.location.pathname+"?page=erp-hr&section=leave&status=1";window.location.replace(i)}},error:function(e){t.showError(e)}})}})},reject:function(t){t.preventDefault();var a={id:e(this).data("id")};e.erpPopup({title:wpErpHr.popup.leave_reject,button:wpErpHr.popup.leave_reject_btn,id:"erp-hr-leave-reject-popup",content:wperp.template("erp-hr-leave-reject-js-tmp")(a).trim(),extraClass:"smaller",onSubmit:function(t){wp.ajax.send({data:this.serialize()+"&_wpnonce="+wpErpHr.nonce,success:function(t){var a="";if(t.errors)e.each(t.errors,function(e,t){a+='<div class="notice notice-error is-dismissible"><p>'+t[0]+"</p></div>"}),""!=a&&e("#leave-reject-form-error").html(a);else if(t.redirect){var i=window.location.origin+window.location.pathname+"?1=1";e.each(t.redirect,function(e,t){i+="&"+e+"="+t}),window.location.replace(i)}else{i=window.location.origin+window.location.pathname+"?page=erp-hr&section=leave&status=3";window.location.replace(i)}},error:function(e){t.showError(e)}})}})},remove:function(t){t.preventDefault();var a=e(this);confirm(wpErpHr.delConfirmRequest)&&wp.ajax.send("erp-hr-leave-request-delete",{data:{_wpnonce:wpErpHr.nonce,id:a.data("id")},success:function(){a.closest("tr").fadeOut("fast",function(){e(this).remove()})},error:function(e){alert(e)}})}},importICalInit:function(t){t.preventDefault(),e("body #erp-ical-input").trigger("click")},uploadICal:function(a){a.preventDefault();var i=a.target.files[0],r=new FormData,n=e(this).parents("form");r.append("ics",i),r.append("action","erp-hr-import-ical"),r.append("_wpnonce",wpErpHr.nonce),wp.ajax.send({data:r,cache:!1,processData:!1,contentType:!1,beforeSend:function(){e("#erp-holiday-uploading").show()},success:function(a){var i="";a&&a.length&&"object"==typeof a?(a.forEach(function(e,t){i+='<tr data-id="'+t+'"><td><input readonly onfocus="this.blur()" type="text" name="title[]" value="'+e.title+'"/></td><td><input readonly onfocus="this.blur()" type="text" name="start[]" class="erp-leave-datetime-picker-from" value="'+e.start+'"/></td><td><input readonly onfocus="this.blur()" type="text" name="end[]" class="erp-leave-datetime-picker-to" value="'+e.end+'"/></td><td id="duration-'+t+'">'+e.duration+'</td></tr><input type="hidden" name="description[]" value="'+e.description+'"/>'}),e("#holiday-import-hint").html("** "+wpErpHr.import_hint),e("#erp-hr-holiday-data thead").show()):(i+='<tr><td colspan="4">'+a+"</td></tr>",e("#holiday-import-hint").html(""),e("#erp-hr-holiday-data thead").hide()),e("#erp-hr-holiday-data tbody").html(i),t.initDateField(),n[0].reset(),e("#erp-holiday-uploading").hide()},error:function(t){n[0].reset(),alert(t),e("#erp-holiday-uploading").hide()}})},customFilterLeaveReport:function(){if("custom"!=this.value)e("#custom-input").remove();else{e("#custom-date-range").after('<span id="custom-input" style="float:left"><span>From </span><input name="start" class="erp-leave-date-field" type="text">&nbsp;<span>To </span><input name="end" class="erp-leave-date-field" type="text"></span>')}t.initDateField()},checkDateRange:function(){new Date(this.value).getFullYear()>(new Date).getFullYear()&&(alert("Enter date range between current year"),this.value="")}};e(function(){t.initialize()})}(jQuery);